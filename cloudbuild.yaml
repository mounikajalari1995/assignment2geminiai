options:
  logging: CLOUD_LOGGING_ONLY  # Specify how logging should be handled

steps:
  # Fetch the service account key from GCS and store it in Cloud Storage
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Downloading service account key..."
        gsutil cp gs://mnkcloud/service-account-key.json /workspace/service-account-key.json
        
        # Verify the key file
        echo "Listing files in /workspace directory..."
        ls -l /workspace
        
        echo "Displaying contents of the service account key file..."
        cat /workspace/service-account-key.json
        
        # Activate service account using the key file
        echo "Activating service account..."
        gcloud auth activate-service-account --key-file=/workspace/service-account-key.json

  # Create Docker registry secret
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Creating Docker registry secret..."
        kubectl create secret docker-registry regcred \
          --docker-server=gcr.io \
          --docker-username=_json_key \
          --docker-password="$(cat /workspace/service-account-key.json)" \
          --docker-email=mounika8036@mounika8036-426015.iam.gserviceaccount.com

  # Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/geminiai:$SHORT_SHA', '.']

  # Push Docker image to Google Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/geminiai:$SHORT_SHA']

  # Apply Kubernetes deployment
  - name: 'gcr.io/cloud-builders/kubectl'
    args: ['apply', '-f', './deployment.yaml']
    env: ['CLOUDSDK_COMPUTE_ZONE=us-central1-a', 'CLOUDSDK_CONTAINER_CLUSTER=geminiai']

  # Apply Kubernetes service
  - name: 'gcr.io/cloud-builders/kubectl'
    args: ['apply', '-f', './service.yaml']
    env: ['CLOUDSDK_COMPUTE_ZONE=us-central1-a', 'CLOUDSDK_CONTAINER_CLUSTER=geminiai']

timeout: 1200s  # Timeout for the build process
